function EnviraAlbumGalleriesUpdate(){EnviraAlbumGalleries.reset();var e="ul#envira-album-drag-drop-area li.envira-gallery-image";jQuery(e).each(function(){var e=jQuery.parseJSON(jQuery(this).attr("data-envira-album-gallery-model"));e.alt=EnviraAlbumStripslashes(e.alt),EnviraAlbumGalleries.add(new EnviraAlbumGallery(e))})}function EnviraAlbumStripslashes(e){return(e+"").replace(/\\(.?)/g,function(e,a){switch(a){case"\\":return"\\";case"0":return"\x00";case"":return"";default:return a}})}jQuery(document).ready(function($){$("a.envira-album-galleries-delete").click(function(e){e.preventDefault();var a=confirm(envira_albums_metabox.remove_multiple);if(!a)return!1;var i=[];$("ul#envira-album-drag-drop-area > li.selected").each(function(){$(this).parent().appendTo($(envira_album_available_galleries)).draggable(envira_album_draggable_options)}),$(envira_album_selected_galleries).trigger("sortupdate")}),$("#envira-albums").on("click",".envira-gallery-remove-image",function(e){e.preventDefault();var a=confirm(envira_albums_metabox.remove);a&&($(this).parent().appendTo($(envira_album_available_galleries)).draggable(envira_album_draggable_options),$(envira_album_selected_galleries).trigger("sortupdate"))})}),wp.media.view.EnviraAlbumError=wp.Backbone.View.extend({tagName:"div",className:"notice error envira-albums-error",render:function(){return this.template=wp.media.template("envira-albums-error"),this.$el.html(this.template(this.model)),this}}),wp.media.view.EnviraAlbumItem=wp.Backbone.View.extend({tagName:"li",className:"attachment envira-gallery-item",template:wp.template("envira-albums-item"),render:function(){return this.$el.html(this.template(this.model.toJSON())),this.model.get("is_cover_image")&&this.$el.addClass("selected"),this}});var EnviraAlbumGallery=Backbone.Model.extend({defaults:{id:"",title:"",caption:"",alt:"",cover_image_id:"",cover_image_url:"",link_new_window:"",cover_image_url_thumb:""}}),EnviraAlbumGalleryImage=Backbone.Model.extend({defaults:{id:"",title:"",src:"",thumb:"",is_cover_image:!1}}),EnviraAlbumGalleries=new Backbone.Collection,EnviraAlbumModalWindow=new wp.media.view.Modal({controller:{trigger:function(){}}}),EnviraAlbumEditView=wp.Backbone.View.extend({tagName:"div",className:"edit-attachment-frame mode-select hide-menu hide-router",template:wp.template("envira-albums-meta-editor"),events:{"click .edit-media-header .left":"loadPreviousItem","click .edit-media-header .right":"loadNextItem","click li.attachment":"updateCoverImage","keyup input":"updateItem","keyup textarea":"updateItem","change input":"updateItem","change textarea":"updateItem","blur textarea":"updateItem","change select":"updateItem","click .actions a.envira-gallery-meta-submit":"saveItem"},initialize:function(e){this.on("loading",this.loading,this),this.on("loaded",this.loaded,this),this.is_loading=!1,this.collection=e.collection,this.images_collection=new Backbone.Collection,this.child_views=e.child_views,this.gallery_id=e.gallery_id,this.gallery_index=0,this.search_timer="";var a=0;this.collection.each(function(e){return e.get("id")==this.gallery_id?(this.model=e,this.gallery_index=a,!1):void a++},this)},render:function(){return this.trigger("loading"),this.$el.html(this.template(this.model.attributes)),this.child_views.length>0&&this.child_views.forEach(function(e){var a=new e({model:this.model});this.$el.find("div.addons").append(a.render().el)},this),this.$el.find("textarea[name=caption]").val(this.model.get("caption")),setTimeout(function(){quicktags({id:"caption",buttons:"strong,em,link,ul,ol,li,close"}),QTags._buttonsInit()},500),0==this.images_collection.length?wp.media.ajax("envira_albums_get_gallery_images",{context:this,data:{nonce:envira_albums_metabox.get_gallery_images_nonce,gallery_id:this.model.get("id")},success:function(e){images=[];for(var a in e)images.push(e[a]);var i=new Backbone.Collection(images);this.images_collection.add(i.models),this.images_collection.each(function(e){e.get("id")==this.model.get("cover_image_id")?e.set("is_cover_image",!0):e.get("src")==this.model.get("cover_image_url")?e.set("is_cover_image",!0):e.set("is_cover_image",!1),this.$el.find("ul.attachments").append(this.renderItem(e))},this),this.trigger("loaded")},error:function(e){this.trigger("loaded",e)}}):this.images_collection.each(function(e){e.get("id")==this.model.get("cover_image_id")?e.set("is_cover_image",!0):e.set("is_cover_image",!1),this.$el.find("ul.attachments").append(this.renderItem(e))},this),this},renderItem:function(e){var a=new wp.media.view.EnviraAlbumItem({model:e});return a.render().el},renderError:function(e){var a={};a.error=e;var i=new wp.media.view.EnviraAlbumError({model:a});return i.render().el},loading:function(){this.is_loading=!0,this.$el.find(".spinner").css("visibility","visible")},loaded:function(e){this.is_loading=!1,this.$el.find(".spinner").css("visibility","hidden"),"undefined"!=typeof e&&this.$el.find("ul.attachments").before(this.renderError(e))},loadPreviousItem:function(){this.gallery_index--,this.model=this.collection.at(this.gallery_index),this.gallery_id=this.model.get("id"),this.images_collection=new Backbone.Collection,this.render()},loadNextItem:function(){this.gallery_index++,this.model=this.collection.at(this.gallery_index),this.gallery_id=this.model.get("id"),this.images_collection=new Backbone.Collection,this.render()},updateCoverImage:function(e){var a=jQuery(e.currentTarget),i=jQuery("div.attachment-preview",a).attr("data-id");a.hasClass("selected")||(this.images_collection.each(function(e){e.get("id")==i&&(this.model.set("cover_image_id",e.get("id")),this.model.set("cover_image_url",e.get("src")),this.model.set("cover_image_url_thumb",e.get("thumb")),this.render())},this),a.addClass("selected details"))},updateItem:function(e){""!=e.target.name&&("checkbox"==e.target.type?value=e.target.checked?1:0:value=e.target.value,this.model.set(e.target.name,value))},saveItem:function(){this.trigger("loading"),wp.media.ajax("envira_albums_update_gallery",{context:this,data:{nonce:envira_albums_metabox.save_nonce,post_id:envira_albums_metabox.id,gallery_id:this.model.get("id"),meta:this.model.attributes},success:function(e){this.trigger("loaded loaded:success");var a=JSON.stringify(this.model.attributes),i=jQuery("ul#envira-album-drag-drop-area li#envira-gallery-"+this.model.get("id"));jQuery(i).attr("data-envira-album-gallery-model",a),jQuery("img",i).attr("src",this.model.get("cover_image_thumb")),jQuery("div.meta div.title",i).text(this.model.get("title"));var t=this.$el.find(".saved");t.fadeIn(),setTimeout(function(){t.fadeOut()},1500)},error:function(e){this.trigger("loaded loaded:error",e)}})}}),EnviraAlbumChildViews=[];jQuery(document).ready(function($){EnviraAlbumGalleriesUpdate(),$("#envira-albums").on("click","a.envira-gallery-modify-image",function(e){e.preventDefault(),EnviraAlbumGalleriesUpdate();var a=$(this).parent().data("envira-gallery");EnviraAlbumModalWindow.content(new EnviraAlbumEditView({collection:EnviraAlbumGalleries,child_views:EnviraAlbumChildViews,gallery_id:a})),EnviraAlbumModalWindow.open()})}),jQuery(document).ready(function($){$("li",$(envira_album_available_galleries)).draggable(envira_album_draggable_options),$(envira_album_available_galleries).on("click","li.envira-gallery-image",function(){$(this).hasClass("selected")?$(this).removeClass("selected"):$(this).addClass("selected"),$("li.selected",$(envira_album_available_galleries)).length>0?$("a.envira-galleries-add").fadeIn():$("a.envira-galleries-add").fadeOut()}),$("a.envira-galleries-add").on("click",function(e){e.preventDefault(),$("p.drag-drop-info").hide(),$("li.selected",$(envira_album_available_galleries)).each(function(){$(this).removeClass("selected").appendTo($(envira_album_selected_galleries))}),$("a.envira-galleries-add").fadeOut(),$(envira_album_selected_galleries).trigger("sortupdate")})});var envira_albums_gallery_search="input#envira-albums-gallery-search",envira_albums_gallery_search_timer=null;jQuery(document).ready(function($){function e(e){e.length<3&&e.length>0||$.ajax({url:envira_albums_metabox.ajax,type:"post",async:!0,cache:!1,data:{action:"envira_albums_search_galleries",search_terms:e,post_id:envira_albums_metabox.id,nonce:envira_albums_metabox.search},success:function(e){e.length>0&&($(envira_album_available_galleries).html(e),$("li",$(envira_album_available_galleries)).draggable(envira_album_draggable_options)),envira_albums_gallery_search_timer=null},error:function(e,a,i){$("#envira-albums-main").before('<div class="error"><p>'+a.responseText+"</p></div>"),envira_albums_gallery_search_timer=null}})}$(envira_albums_gallery_search).keyup(function(){envira_albums_gallery_search_timer&&window.clearTimeout(envira_albums_gallery_search_timer),envira_albums_gallery_search_timer=window.setTimeout(function(){e($(envira_albums_gallery_search).val())},500)}),$(envira_albums_gallery_search).on("search",function(){e("")})});var envira_album_selected_galleries="ul#envira-album-drag-drop-area",envira_album_available_galleries="ul#envira-albums-output",envira_album_container="#envira-album-main",envira_album_meta_container=".envira-gallery-meta-container",envira_album_draggable_options={helper:"clone",connectToSortable:"#envira-album-drag-drop-area",revert:"invalid"};jQuery(document).ready(function($){$(envira_album_selected_galleries).sortable({stop:function(e,a){$("p.drag-drop-info").addClass("hidden");var i=a.item,t=$(i).data("envira-gallery");$(i).attr("id","envira-gallery-"+t),a.item.removeClass("selected"),setTimeout(function(){$("li[data-envira-gallery='"+t+"']",$(envira_album_available_galleries)).remove()},100)}}),$(envira_album_selected_galleries).on("sortupdate",function(){EnviraAlbumGalleriesUpdate();var e=[],a=[];EnviraAlbumGalleries.each(function(i){e.push(i.get("id")),a.push(i.attributes)}),$("input[name=galleryIDs]").val(e.join(",")),$.ajax({url:envira_albums_metabox.ajax,type:"post",async:!0,cache:!1,dataType:"json",data:{action:"envira_albums_sort_galleries",gallery_ids:e,galleries:a,post_id:envira_albums_metabox.id,nonce:envira_albums_metabox.sort},success:function(e){},error:function(e,a,i){$(envira_album_selected_galleries).before('<div class="error"><p>'+a.responseText+"</p></div>")}})})});